name: nightly

permissions:
  contents: read
  pull-requests: read

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  constants:
    uses: ./.github/workflows/repo-constants.yml

  nightly-gatekeeper:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
    steps:
      - uses: actions/checkout@v6.0.0
        with:
          fetch-depth: 0

      - name: Check for changes in last 24 hours
        id: check
        run: |
          # Check logs for commits in the last 24 hours on the current branch
          if [[ -z $(git log --since="24 hours ago" --pretty=format:"%H") ]]; then
            echo "No commits in the last 24 hours. Skipping..."
            echo "should_skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "New commits found. Proceeding..."
            echo "should_skip=false" >> "$GITHUB_OUTPUT"
          fi

  mutation-testing:
    needs: [constants, nightly-gatekeeper]
    if: ${{ needs.nightly-gatekeeper.outputs.should_skip != 'true' }}
    runs-on: ubuntu-latest
    env:
      RUST_MSRV: ${{ needs.constants.outputs.RUST_MSRV }}
      RUST_LATEST: ${{ needs.constants.outputs.RUST_LATEST }}
      RUST_NIGHTLY: ${{ needs.constants.outputs.RUST_NIGHTLY }}
      RUST_NIGHTLY_EXTERNAL_TYPES: ${{ needs.constants.outputs.RUST_NIGHTLY_EXTERNAL_TYPES }}
      CARGO_AUDIT_VERSION: ${{ needs.constants.outputs.CARGO_AUDIT_VERSION }}
      CARGO_CHECK_EXTERNAL_TYPES_VERSION: ${{ needs.constants.outputs.CARGO_CHECK_EXTERNAL_TYPES_VERSION }}
      CARGO_DENY_VERSION: ${{ needs.constants.outputs.CARGO_DENY_VERSION }}
      CARGO_ENSURE_NO_CYCLIC_DEPS_VERSION: ${{ needs.constants.outputs.CARGO_ENSURE_NO_CYCLIC_DEPS_VERSION }}
      CARGO_ENSURE_NO_DEFAULT_FEATURES_VERSION: ${{ needs.constants.outputs.CARGO_ENSURE_NO_DEFAULT_FEATURES_VERSION }}
      CARGO_HACK_VERSION: ${{ needs.constants.outputs.CARGO_HACK_VERSION }}
      CARGO_LLVM_COV_VERSION: ${{ needs.constants.outputs.CARGO_LLVM_COV_VERSION }}
      CARGO_MUTANTS_VERSION: ${{ needs.constants.outputs.CARGO_MUTANTS_VERSION }}
      CARGO_RDME_VERSION: ${{ needs.constants.outputs.CARGO_RDME_VERSION }}
      CARGO_SEMVER_CHECKS_VERSION: ${{ needs.constants.outputs.CARGO_SEMVER_CHECKS_VERSION }}
      CARGO_SORT_VERSION: ${{ needs.constants.outputs.CARGO_SORT_VERSION }}
      CARGO_UDEPS_VERSION: ${{ needs.constants.outputs.CARGO_UDEPS_VERSION }}
      CARGO_WORKSPACES_VERSION: ${{ needs.constants.outputs.CARGO_WORKSPACES_VERSION }}
      SCCACHE_VERSION: ${{ needs.constants.outputs.SCCACHE_VERSION }}
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    permissions:
      issues: write
    steps:
      # prep
      - name: Checkout
        uses: actions/checkout@v6.0.0
      - name: Start sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: ${{ env.SCCACHE_VERSION }}
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1.15.2
        with:
          toolchain: ${{ env.RUST_LATEST }},nightly
      - name: Installing Wild Linker
        uses: davidlattimore/wild-action@0.7.0
      - name: Install Cargo Tools
        uses: taiki-e/install-action@v2.62.62
        with:
          tool: cargo-mutants@${{ env.CARGO_MUTANTS_VERSION }}

      # execute
      - name: Mutate All
        id: mutate
        continue-on-error: true
        env:
          DISABLE_T_REX: 1
        run: cargo +nightly -Zscript scripts/mutants.rs

      - name: Create or Update Issue on Failure
        if: steps.mutate.outcome != 'success' && steps.mutate.outcome != 'skipped'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_TITLE="ðŸš¨ Nightly Build Failed"
          ISSUE_DATE="$(date +'%Y-%m-%d')"
          ISSUE_FULL_TITLE="$ISSUE_TITLE: $ISSUE_DATE"
          ISSUE_BODY="The nightly scheduled build failed. Please check the logs here: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          # Search for open issues with the same base title and label
          EXISTING_ISSUE=$(gh issue list --label "bug" --state open --search "$ISSUE_TITLE" --json number,title | jq -r '.[] | select(.title | startswith("'"$ISSUE_TITLE"'")) | .number' | head -n 1)
          if [[ -n "$EXISTING_ISSUE" ]]; then
            # Add a comment to the existing issue
            gh issue comment "$EXISTING_ISSUE" --body "$ISSUE_BODY"
          else
            # Create a new issue
            gh issue create \
              --title "$ISSUE_FULL_TITLE" \
              --body "$ISSUE_BODY" \
              --label "bug"
          fi

      - name: Check for Step Failure
        if: steps.mutate.outcome != 'success' && steps.mutate.outcome != 'skipped'
        run: exit 1
