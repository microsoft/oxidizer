# Exposes values defined in constants.toml to other workflows.
name: repo-constants
permissions:
  contents: read

on:
  workflow_call:
    outputs:
      repo_constants_json:
        description: Serialized key/value map sourced from constants.toml
        value: ${{ jobs.export.outputs.repo_constants_json }}

jobs:
  export:
    runs-on: ubuntu-latest
    outputs:
      repo_constants_json: ${{ steps.set.outputs.repo_constants_json }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.0
        with:
          fetch-depth: 1
      - id: set
        shell: pwsh
        run: |
          $constantsPath = Join-Path $PWD 'constants.toml'
          $outputPath = $env:GITHUB_OUTPUT
          $pattern = '^[\s]*([A-Z0-9_]+)[\s]*=[\s]*"([^"\\]*(?:\\.[^"\\]*)*)"'
          $constants = [ordered]@{}

          Get-Content -Path $constantsPath | ForEach-Object {
            if ($_ -match $pattern) {
              $key = $matches[1]
              $value = $matches[2]
              $constants[$key] = $value
            }
          }

          $json = ($constants | ConvertTo-Json -Compress)
          Add-Content -Path $outputPath -Value "repo_constants_json=$json"
